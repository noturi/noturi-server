// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  GOOGLE
  APPLE
}

enum RecurrenceType {
  NONE
  DAILY
  WEEKLY
  MONTHLY
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

model User {
  id       String  @id @default(uuid())
  nickname String
  email    String  @unique
  name     String? // 실제 이름 (OAuth에서 가져옴)

  // OAuth 인증 (nullable - 어드민은 로컬 인증 가능)
  providers  AuthProvider[]
  providerId String?        @unique
  avatarUrl  String?

  // 로컬 인증 (어드민용)
  password String? // bcrypt 해시

  isStatsPublic Boolean  @default(false)
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Todo 통계
  totalTodos     Int @default(0) // 전체 투두 수
  completedTodos Int @default(0) // 완료한 투두 수
  currentStreak  Int @default(0) // 현재 연속 달성일
  bestStreak     Int @default(0) // 최고 연속 달성일

  categories    Category[]
  memos         Memo[]
  refreshTokens RefreshToken[]
  calendarMemos CalendarMemo[]
  devices       UserDevice[] // 푸시 알림용 디바이스
  settings      UserSettings? // 사용자 설정
  todoTemplates TodoTemplate[]
  todoInstances TodoInstance[]

  @@index([providerId])
  @@index([email])
  @@map("users")
}

// 사용자 디바이스 (푸시 알림용)
model UserDevice {
  id            String  @id @default(uuid())
  expoPushToken String  @unique // Expo Push Token
  deviceName    String? // 기기 이름 (예: "iPhone 15 Pro")
  platform      String? // ios, android

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  isActive     Boolean  @default(true) // 토큰 유효 여부
  createdAt    DateTime @default(now())
  lastActiveAt DateTime @updatedAt

  @@index([userId])
  @@index([expoPushToken])
  @@map("user_devices")
}

model Category {
  id        String          @id @default(uuid())
  name      String
  color     String? // UI 색상용
  sortOrder Int             @default(0)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  memos     Memo[]
  fields    CategoryField[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([userId, name])
  @@index([userId])
  @@map("categories")
}

model CategoryField {
  id         String            @id @default(uuid())
  name       String // ex: 감독, 저자
  category   Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String
  memoFields MemoCustomField[]

  @@unique([categoryId, name])
  @@index([categoryId])
  @@map("category_fields")
}

model Memo {
  id             String    @id @default(uuid())
  title          String // 필수
  content        String? // 본문 (optional)
  rating         Decimal?  @db.Decimal(2, 1) // 1.0~5.0, 0.5단위 (optional)
  experienceDate DateTime? // 경험 날짜 (optional)

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  categoryId String?

  customFields MemoCustomField[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([categoryId])
  @@index([rating])
  @@index([createdAt])
  @@index([userId, rating])
  @@index([userId, categoryId])
  @@map("memos")
}

model MemoCustomField {
  id    String @id @default(uuid())
  value String

  memo            Memo          @relation(fields: [memoId], references: [id], onDelete: Cascade)
  memoId          String
  categoryField   CategoryField @relation(fields: [categoryFieldId], references: [id], onDelete: Cascade)
  categoryFieldId String

  @@unique([memoId, categoryFieldId])
  @@index([memoId])
  @@map("memo_custom_fields")
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?

  @@index([userId])
  @@map("refresh_tokens")
}

model DefaultCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  color       String
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("default_categories")
}

enum NotificationTime {
  AT_START_TIME
  FIVE_MINUTES_BEFORE
  TEN_MINUTES_BEFORE
  FIFTEEN_MINUTES_BEFORE
  THIRTY_MINUTES_BEFORE
  ONE_HOUR_BEFORE
  TWO_HOURS_BEFORE
  THREE_HOURS_BEFORE
  ONE_DAY_BEFORE
  TWO_DAYS_BEFORE
  THREE_DAYS_BEFORE
  ONE_WEEK_BEFORE
}

model CalendarMemo {
  id               String            @id @default(uuid())
  title            String
  startDate        DateTime // 시작 날짜/시간
  endDate          DateTime // 끝 날짜/시간
  isAllDay         Boolean           @default(false) // 하루종일 여부
  hasNotification  Boolean           @default(false)
  notifyBefore     NotificationTime? // 시작 날짜 기준 알림 시점
  notificationSent Boolean           @default(false) // 알림 발송 여부

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([startDate])
  @@index([userId, startDate])
  @@index([hasNotification, notificationSent]) // 알림 조회용 인덱스
  @@map("calendar_memos")
}

enum Theme {
  light
  dark
  sepia
  navy
  forest
  lavender
}

enum Language {
  ko
  en
}

model UserSettings {
  id String @id @default(uuid())

  theme        Theme    @default(light)
  language     Language @default(ko)
  notification Boolean  @default(true)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

// 어드민 푸시 알림
model AdminNotification {
  id    String @id @default(uuid())
  title String // 알림 제목
  body  String // 알림 내용
  data  Json?  // 추가 데이터 (딥링크 등)

  // 대상 유저 ID 배열
  targetUserIds String[]

  // 예약 설정
  scheduledAt   DateTime? // 예약 발송 시간 (null이면 즉시 발송)
  scheduledTime String?   // 반복시 매일 발송할 시간 (HH:mm 형식)

  // 반복 설정
  isRepeat     Boolean   @default(false)
  repeatDays   Int[]     // 반복 요일 (0=일, 1=월, 2=화, 3=수, 4=목, 5=금, 6=토)
  repeatEndAt  DateTime? // 반복 종료일

  // 상태
  isActive   Boolean   @default(true) // 활성화 여부 (반복 알림 중지용)
  lastSentAt DateTime? // 마지막 발송 시간

  // 발송 로그
  logs AdminNotificationLog[]

  // 메타
  createdBy String   // 생성한 어드민 ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, scheduledAt])
  @@index([isActive, isRepeat])
  @@map("admin_notifications")
}

// 어드민 알림 발송 로그
model AdminNotificationLog {
  id             String            @id @default(uuid())
  notification   AdminNotification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  notificationId String

  sentAt       DateTime @default(now())
  successCount Int      @default(0)
  failCount    Int      @default(0)
  details      Json?    // 상세 결과 (실패한 토큰 등)

  @@index([notificationId])
  @@index([sentAt])
  @@map("admin_notification_logs")
}

// 앱 버전 관리
model AppVersion {
  id String @id @default(uuid())

  iosVersion        String // iOS 최신 버전
  iosMinVersion     String // iOS 최소 지원 버전 (이하면 강제 업데이트)
  iosStoreUrl       String // 앱스토어 URL

  androidVersion    String // Android 최신 버전
  androidMinVersion String // Android 최소 지원 버전
  androidStoreUrl   String // 플레이스토어 URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_versions")
}

// 반복 투두 템플릿
model TodoTemplate {
  id             String         @id @default(uuid())
  title          String
  description    String?
  recurrenceType RecurrenceType @default(NONE) // NONE, DAILY, WEEKLY, MONTHLY
  recurrenceDays Int[] // WEEKLY: 요일(0~6), MONTHLY: 날짜(1~31)
  startDate      DateTime // 시작 날짜
  endDate        DateTime? // 종료 날짜 (null = 무기한)
  isActive       Boolean        @default(true)

  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  instances TodoInstance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
  @@index([userId, isActive])
  @@map("todo_templates")
}

// 날짜별 투두 인스턴스
model TodoInstance {
  id          String    @id @default(uuid())
  title       String
  description String?
  date        DateTime // 해당 날짜 (00:00:00)
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  template   TodoTemplate? @relation(fields: [templateId], references: [id], onDelete: Cascade)
  templateId String? // null이면 일회성 투두
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([templateId, date]) // 같은 템플릿에서 같은 날짜 중복 방지
  @@index([userId])
  @@index([date])
  @@index([userId, date])
  @@index([isCompleted])
  @@map("todo_instances")
}
